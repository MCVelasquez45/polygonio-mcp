# Polygon Market Analysis Agent

GPT‑5 powered financial analyst that pairs the OpenAI Agents SDK with Polygon.io’s MCP server. The agent ships with an interactive CLI, a FastAPI surface, and a shared core that encapsulates all guardrails, tools, and Polygon/FRED integrations.

> ⚠️ **Disclaimer:** Outputs are generated by AI, can be incomplete or inaccurate, and are provided for informational purposes only. Nothing here constitutes financial advice.

---

## Key Capabilities

- **Unified agent core** – `core/polygon_agent.py` defines the data fetchers, tool catalog, guardrails, and the reusable `run_analysis` helper that both entrypoints call.
- **Finance-only guardrail** – every prompt is screened before invoking Polygon to prevent accidental non-financial queries from wasting tokens or API quota.
- **Rich tool coverage** – options snapshots, contract-level quotes/trades, intraday aggregates, earnings/dividends/financials, news sentiment, FRED macro series, and Markdown report generation.
- **Session persistence** – conversation state is stored in a local SQLite session (bounded history) so follow-up questions have context.
- **MCP-based data plane** – the Polygon MCP server is started automatically via `uvx` so no custom infra is required.

---

## Requirements

- Python **3.10+**
- [uv](https://github.com/astral-sh/uv) or `pip` for dependency management
- API keys:
  - `OPENAI_API_KEY`
  - `POLYGON_API_KEY`
  - `FRED_API_KEY` (required for macro queries)

Duplicate the supplied `env.example` to `.env` and fill in the keys:

```bash
cp env.example .env
```

---

## Quickstart

```bash
cd agent
uv sync             # or: pip install -e .
uv run python main.py
```

Need to automate a single question (non-interactive)? Pipe the prompt and an `exit` command:

```bash
printf 'Analyze TSLA earnings reaction\nexit\n' | uv run python main.py
```

Type `exit` (or press `Ctrl+D`) inside the CLI to terminate the session.

---

## FastAPI Service

```bash
cd agent
uv run uvicorn api:app --reload --port 5001
```

`POST /analyze`

```json
{
  "query": "Analyze TSLA earnings reaction",
  "session_name": "my-session-1"
}
```

The response returns the rendered Markdown plus the session identifier so you can stitch conversational threads across HTTP requests.

---

## Environment Variables

| Variable | Purpose |
| --- | --- |
| `OPENAI_API_KEY` | Access to GPT‑5 via the OpenAI Agents SDK |
| `POLYGON_API_KEY` | Authenticates the Polygon MCP server |
| `FRED_API_KEY` | Enables FRED macro tool calls |
| `FINANCE_AGENT_HISTORY_LIMIT` | (optional) Number of previous turns to replay (default 0 to avoid truncating reasoning/function-call pairs) |
| `FINANCE_AGENT_REPORTS_DIR` | (optional) Custom folder for saved Markdown reports |

---

## Project Layout

```
agent/
├── api.py                 # FastAPI surface delegating to run_analysis
├── cli/
│   ├── __init__.py        # Exports run_cli
│   ├── app.py             # Async CLI loop (session + MCP lifecycle)
│   └── messages.py        # Rich console formatting helpers
├── core/
│   ├── __init__.py
│   └── polygon_agent.py   # Agent factory, guardrails, Polygon/FRED tools
├── main.py                # Thin entrypoint that runs the CLI app
├── env.example            # Sample environment variables
├── pyproject.toml         # Dependencies + packaging metadata
└── reports/               # Markdown reports generated via save_analysis_report
```

---

## Agent Architecture Walkthrough

1. **MCP bootstrap** – `create_polygon_mcp_server()` spins up Polygon’s stdio MCP server with your `POLYGON_API_KEY`.
2. **Tooling & guardrails** – `create_financial_analysis_agent()` wires Polygon + FRED tools, the finance-only guardrail, and GPT‑5 model settings into a single Agent SDK object.
3. **Session-aware execution** – `run_analysis()` accepts a query and optional session/server references, trims session history, wraps the run in tracing, and returns the final response.
4. **CLI** – `cli/app.py` owns the interactive loop, console UX, and graceful shutdown. It injects the shared session + MCP server so every query reuses the same context.
5. **API** – `api.py` exposes `run_analysis()` over HTTP with proper error handling for guardrail trips and runtime issues.

Because everything funnels through `run_analysis()`, improvements to the tooling or reasoning stack automatically benefit every surface.

---

## Saving Reports

Ask the agent to “save a report” (or call `save_analysis_report` directly) and it will persist a Markdown summary to `reports/<timestamp>_<title>.md`. The directory is git-ignored by default so sensitive outputs stay local. Point `FINANCE_AGENT_REPORTS_DIR` to another folder if you prefer.

---

## Troubleshooting

- **Guardrail triggered:** The query was not deemed finance-related. Rephrase to include explicit financial context.
- **`POLYGON_API_KEY not set` errors:** Ensure `.env` sits beside `main.py` and contains the key, or export it in your shell.
- **`uvx` not found:** Install uv (`pip install uv` or `curl -Ls https://astral.sh/uv/install.sh | sh`).
- **Permission errors writing reports:** Update `FINANCE_AGENT_REPORTS_DIR` to a writable path.

---

## Contributing / Development Notes

- Format & lint using your preferred tooling; the repository intentionally keeps dependencies lightweight.
- Run `python -m py_compile main.py cli/app.py cli/messages.py` (with `PYTHONPYCACHEPREFIX` set) to do a quick syntax check without spawning caches outside the repo.
- When adding new tools, declare them in `core/polygon_agent.py`, import them into `core/__init__.py`, and register them inside `create_financial_analysis_agent()` so both CLI and API can access them.

---

## License

This agent is released under the [MIT License](LICENSE).
